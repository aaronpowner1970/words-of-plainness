{% extends "layouts/base.njk" %}

{% block styles %}
<link rel="stylesheet" href="/css/chapter.css?v={{ site.version }}">
{% endblock %}

{% block content %}
<!-- Reading Progress Bar -->
<div class="reading-progress">
    <div class="reading-progress-fill" id="readingProgressFill"></div>
</div>

<!-- Resume Prompt -->
{% include "components/resume-prompt.njk" %}

<!-- Progress Resume Banner (API-synced) -->
<div class="progress-resume-banner hidden" id="progressResumeBanner">
    <div class="progress-resume-content">
        <span class="progress-resume-text" id="progressResumeText">
            Welcome back! Resume reading from where you left off?
        </span>
        <div class="progress-resume-actions">
            <button class="progress-resume-btn" id="progressResumeYes">Resume</button>
            <button class="progress-resume-btn secondary" id="progressResumeNo">Start from Beginning</button>
        </div>
        <div class="progress-resume-reflect-divider"></div>
        <button class="progress-resume-btn outline" id="progressResumeReflect">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
            Record Personal Reflection
        </button>
    </div>
</div>

<!-- Bookmark Toast -->
<div class="bookmark-toast hidden" id="bookmarkToast">Bookmark saved</div>

<!-- Mobile TOC Panel -->
{% include "components/toc-mobile.njk" %}

<!-- Chapter Hero Section -->
<section class="chapter-hero" data-pagefind-ignore>
    <p class="chapter-number">Chapter {{ chapter }}</p>
    <h1 class="chapter-title">{{ title }}</h1>
    <blockquote class="chapter-scripture">
        "{{ scripture.text }}"
        <cite>â€” <a href="https://www.churchofjesuschrist.org/study/scriptures/{{ scripture.url }}" target="_blank" rel="noopener">{{ scripture.reference }}</a></cite>
    </blockquote>
    <p class="chapter-meta">{{ readingTime | readingTime }}</p>
</section>

<!-- Primary Actions Bar (sticky below header) -->
<div data-pagefind-ignore>
{% include "components/floating-action-bar.njk" %}
</div>

<!-- Main Layout: TOC Sidebar + Content -->
<div class="chapter-layout">
    <!-- Desktop TOC Sidebar -->
    <div data-pagefind-ignore>
    {% include "components/toc-sidebar.njk" %}
    </div>

    <!-- Chapter Content -->
    <article class="chapter-content" id="chapterContent" data-pagefind-body>
        <span data-pagefind-meta="title" class="visually-hidden">Chapter {{ chapter }}: {{ title }}</span>
        {{ content | safe }}
    </article>
</div>

<!-- Bottom Learning Tools Dropdown -->
<div data-pagefind-ignore>
{% include "components/study-resources.njk" %}
</div>

<!-- Non-content sections excluded from search -->
<div data-pagefind-ignore>
<!-- Reflection Section -->
{% include "components/reflection-section.njk" %}

<!-- Discord Community Section -->
{% include "components/discord-section.njk" %}

<!-- Chapter Navigation (Prev/Next) -->
{% include "components/chapter-nav.njk" %}

<!-- Audio Player (hidden until activated) -->
{% include "components/audio-player.njk" %}

<!-- Bottom Toolbar -->
{% include "components/bottom-toolbar.njk" %}

<!-- Back to Top Button -->
{% include "components/back-to-top.njk" %}

<!-- Mobile FAB (Lantern Icon) -->
{% include "components/fab-lantern.njk" %}

<!-- Modals (Overview, Testimony, Infographic, Slides) -->
{% include "components/modals.njk" %}
</div>

{% endblock %}

{% block scripts %}
<script src="/js/reading-progress.js"></script>
<script src="/js/chapter.js"></script>
<script src="/js/audio-sync.js"></script>
<script src="/js/reflections.js"></script>
<script>
    // Chapter-specific configuration
    // Timestamps are loaded from src/_data/timestamps/{{ chapterId }}.json
    {% set chapterTimestamps = timestamps[chapterId] or {} %}
    
    const CHAPTER_CONFIG = {
        id: '{{ chapterId }}',
        number: {{ chapter }},
        title: '{{ title }}',
        audioFile: '/assets/audio/{{ audio.narration }}',
        overviewFile: '/assets/audio/{{ audio.overview }}',
        testimonyFile: '/assets/audio/{{ audio.testimony.file }}',
        pdfFile: '/assets/pdf/{{ pdf }}',
        infographicFile: '/assets/images/{{ infographic }}',
        slidesPath: '/assets/slides/{{ slides.path }}',
        totalSlides: {{ slides.count or 10 }},
        discordChannelId: '{{ discordChannelId }}',
        timestamps: {{ chapterTimestamps | json | safe }}
    };
    
    // Initialize chapter functionality
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof ChapterManager !== 'undefined') {
            ChapterManager.init(CHAPTER_CONFIG);
        }
    });
</script>
{% endblock %}
